/*
jQuery: desoBBCode plugin v1.1 - jquery.desobbcode.js
Copyright - 2011 - S.V.
This source code is under the GNU General Public License
contact@chez-syl.fr
*/
(function(a){a.fn.desoBBCode=function(l){var e={firstLegend:"Rédaction",secondLegend:"Visualisation",viewBtn:"Prévisualiser",submitBtn:"Valider",quoteQuestion:"Who is the author?",urlQuestion:"What is the URL?",submitEvent:false};var c=a.extend(e,l);var g=this;var k="desoBBCode_prev_area";var m=g.parents("test");var b="desoBBCode_first";var f="desoBBCode_second";d();a.ajax({url:"ressources/js/jquery.desobbcode.json",dataType:"json",cache:false,success:function(n){i(n)},error:function(p,o,n){alert("xhr.status="+p.status+" error="+o+" exception="+n)}});a("#"+b).on("click","#"+b+' div.desoBBCode_element:eq(0) input[type="button"][id^="desoBBCode_"]',function(){var n=a(this).attr("data-tag");j(n,false)});a("#"+b).on("change",'select[id^="desoBBCode_text_"]',function(){var n=a(this).attr("data-tag");var o=a(this).val();j(n,o)});a("#"+b).on("click","#desoBBCode_prev_btn",function(){h(g,k);return false});a("#"+b).on("submit","form",function(){if(c.submitEvent){h(g,k);c.submitEvent(a("#"+k).html());return false}});a("#"+k).on("click",".desoBBCode_secret > a",function(){var n=a(this).parent().next("div");var o;if(n.is(":visible")){n.slideUp();o="afficher"}else{n.slideDown();o="masquer"}a(this).hide().stop(true,true).text(o).fadeIn();return false});function d(){m.wrap('<fieldset id="'+b+'">');g.wrap('<div class="desoBBCode_element">');a("#"+b).prepend("<legend>");a("#"+b+" > legend").text(c.firstLegend);a("<div></div>",{"class":"desoBBCode_element"}).appendTo(m);a("<input />",{type:"button",id:"desoBBCode_prev_btn","class":"desoBBCode_green_btn",value:c.viewBtn}).appendTo(a("#"+b+" div.desoBBCode_element:last"));a("<input />",{type:"submit","class":"desoBBCode_green_btn",value:c.submitBtn}).appendTo(a("#"+b+" div.desoBBCode_element:last"));m.parents("fieldset").after('<fieldset id="'+f+'">').next("fieldset").prepend("<legend>");a("#"+f+" > legend").text(c.secondLegend);a("<div></div>",{id:"desoBBCode_prev_area"}).appendTo("#"+f)}function i(n){m.prepend('<div class="desoBBCode_element button-group minor-group" />');$firstDiv=m.children("div.desoBBCode_element:eq(0)");a.each(n.inputButton,function(p,o){a("<input />",{class:"button",type:"button",id:o.id,"data-tag":o.tag,value:o.value}).appendTo($firstDiv)});a("<select></select>",{id:"desoBBCode_text_size","data-tag":"size"}).appendTo($firstDiv);a.each(n.selectTextSize,function(p,o){a("<option></option>",{text:o.text,value:o.value}).appendTo("#desoBBCode_text_size")});a("<select></select>",{id:"desoBBCode_text_color","data-tag":"color"}).appendTo($firstDiv);a.each(n.selectTextColor,function(p,o){a("<option></option>",{text:o.text,value:o.value}).appendTo("#desoBBCode_text_color")})}function j(w,u){var p=g.getSelection();var t=g.scrollTop();var q=0;switch(w){case"quote":var o=prompt(c.quoteQuestion,"");g.replaceSelection("["+w+'="'+o+'"]'+p.text+"[/"+w+"]");q=5+o.length;break;case"url":var n=prompt(c.urlQuestion,"");g.replaceSelection("["+w+'="'+n+'"]'+p.text+"[/"+w+"]");q=5+n.length;break;case"size":case"color":if(u!=""){g.replaceSelection("["+w+'="'+u+'"]'+p.text+"[/"+w+"]")}q=5+u.length;a("#desoBBCode_text_"+w).val("");break;default:g.replaceSelection("["+w+"]"+p.text+"[/"+w+"]");q=2;break}g.scrollTop(t);a.fn.selectRange=function(x,s){return this.each(function(){if(this.setSelectionRange){this.focus();this.setSelectionRange(x,s)}else{if(this.createTextRange){var y=this.createTextRange();y.collapse(true);y.moveEnd("character",s);y.moveStart("character",x);y.select()}}})};var v=p.start+q+w.length;var r=v+p.text.length;g.selectRange(v,r)}function h(n,p){var o=n.val();o=o.replace(/&/g,"&amp;");o=o.replace(/\n/g,"<br />").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");o=o.replace(/\[b\](.*?)\[\/b\]/g,"<strong>$1</strong>");o=o.replace(/\[u\](.*?)\[\/u\]/g,"<u>$1</u>");o=o.replace(/\[i\](.*?)\[\/i\]/g,"<em>$1</em>");o=o.replace(/\[strike\](.*?)\[\/strike\]/g,'<span class="desoBBCode_strike">$1</span>');o=o.replace(/\[img\](.*?)\[\/img\]/g,'<img src="$1" alt="Image" />');o=o.replace(/\[secret\](.*?)\[\/secret\]/g,'<span class="desoBBCode_secret">Secret (<a href="#">afficher</a>)</span><div class="desoBBCode_quote">$1</div>');o=o.replace(/\[url\="?(.*?)"?\](.*?)\[\/url\]/g,'<a href="$1">$2</a>');o=o.replace(/\[quote\=\"(.*?)\"\]([\s\S]*?)\[\/quote\]/g,'<br /><span class="desoBBCode_quote_author">$1</span><div class="desoBBCode_quote">$2</div>');o=o.replace(/\[size\="([0-9])"?\](.*?)\[\/size\]/g,'<span class="size-$1">$2</span>');o=o.replace(/\[color\="(.*?)"?\](.*?)\[\/color\]/g,'<span class="color-$1">$2</span>');if(o!=""){a("#"+k).hide().html(o).stop(true,true).fadeIn()}}return this}})(jQuery);